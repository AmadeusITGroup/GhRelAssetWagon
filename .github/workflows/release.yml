name: Enhanced Release with Attestations

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to create attestations for'
        required: true
        type: string
      dry_run:
        description: 'Perform a dry run (validate only, do not publish)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write
  attestations: write
  security-events: write

jobs:
  build-and-attest:
    runs-on: ubuntu-latest
    outputs:
      artifact-hashes: ${{ steps.hash.outputs.hashes }}
      sbom-hash: ${{ steps.sbom-hash.outputs.hash }}
      total_tests: ${{ steps.test-results.outputs.total_tests }}
      passed_tests: ${{ steps.test-results.outputs.passed_tests }}
      failed_tests: ${{ steps.test-results.outputs.failed_tests }}
      success_rate: ${{ steps.test-results.outputs.success_rate }}
      instruction_coverage: ${{ steps.test-results.outputs.instruction_coverage }}
      branch_coverage: ${{ steps.test-results.outputs.branch_coverage }}
      line_coverage: ${{ steps.test-results.outputs.line_coverage }}
      
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@v2
      with:
        egress-policy: audit
        
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        server-id: central
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        settings-path: ${{ github.workspace }}
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Import GPG key
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        mkdir -p ~/.gnupg
        chmod 700 ~/.gnupg
        echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --import 2>&1 | sed 's/<[^>]*>/<***@***.***>/g'
        KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | sed 's/.*\/\([A-F0-9]*\).*/\1/')
        echo "GPG_KEY_ID=$KEY_ID" >> $GITHUB_ENV
        FINGERPRINT=$(gpg --list-secret-keys --with-colons --fingerprint | grep fpr | head -1 | cut -d: -f10)
        echo "$FINGERPRINT:6:" | gpg --batch --import-ownertrust
        echo "use-agent" >> ~/.gnupg/gpg.conf
        echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
        echo "batch" >> ~/.gnupg/gpg.conf
        echo "no-tty" >> ~/.gnupg/gpg.conf
        echo "default-key $KEY_ID" >> ~/.gnupg/gpg.conf
        chmod 600 ~/.gnupg/gpg.conf
        
    - name: Run tests
      env:
        GH_RELEASE_ASSET_TOKEN: test_token
      run: mvn clean test
      
    - name: Build and package artifacts (without signing)
      run: mvn clean verify -DskipTests -Dgpg.skip=true
        
    - name: Generate comprehensive SBOM
      uses: anchore/sbom-action@v0
      with:
        path: .
        format: spdx-json
        output-file: sbom.spdx.json
        upload-artifact: false
        
    - name: Generate CycloneDX SBOM
      run: |
        # The CycloneDX SBOM is generated by the Maven plugin during build
        # Copy the generated SBOM to the expected location
        if [ -f "target/sbom.cyclonedx.json" ]; then
          cp target/sbom.cyclonedx.json sbom.cyclonedx.json
          echo "✅ CycloneDX SBOM copied from Maven build output"
        else
          echo "⚠️  CycloneDX SBOM not found in target/, generating manually..."
          # Generate SBOM using Maven plugin directly
          mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom \
            -DoutputFormat=json \
            -DoutputName=sbom.cyclonedx \
            -DoutputDirectory=.
        fi
        
    - name: Security scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        
    - name: Generate vulnerability report
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'vulnerability-report.json'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        
    - name: Create build metadata (placeholder)
      run: |
        cat > build-metadata.json << EOF
        {
          "build_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "git_commit": "${{ github.sha }}",
          "git_ref": "${{ github.ref }}",
          "workflow_run_id": "${{ github.run_id }}",
          "workflow_run_number": "${{ github.run_number }}",
          "runner_os": "${{ runner.os }}",
          "java_version": "17",
          "maven_version": "$(mvn --version | head -1 | cut -d' ' -f3)",
          "test_results": {
            "total_tests": "pending",
            "passed_tests": "pending",
            "failed_tests": "pending",
            "success_rate": "pending"
          },
          "code_coverage": {
            "instruction_coverage": "pending",
            "branch_coverage": "pending",
            "line_coverage": "pending"
          },
          "build_environment": {
            "github_actor": "${{ github.actor }}",
            "github_repository": "${{ github.repository }}",
            "github_event_name": "${{ github.event_name }}"
          }
        }
        EOF
        
    - name: Sign all artifacts with Maven GPG plugin
      env:
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        # Run Maven verify with GPG signing enabled to create POM in target/ and sign all artifacts
        mvn verify -DskipTests -Dgpg.skip=false -Dgpg.passphrase="${GPG_PASSPHRASE}"
        
        # Sign additional files (SBOM, vulnerability report, metadata) that Maven doesn't handle
        for file in sbom.spdx.json sbom.cyclonedx.json vulnerability-report.json build-metadata.json; do
          if [ -f "$file" ]; then
            gpg --batch --yes --pinentry-mode loopback \
              --passphrase "${GPG_PASSPHRASE}" \
              --armor --detach-sign "$file"
            echo "✅ Signed $file"
          fi
        done
        
    - name: Parse test results and coverage
      id: test-results
      run: |
        # Parse test results
        if [ -f "target/surefire-reports/TEST-"*.xml ]; then
          TOTAL_TESTS=$(xmllint --xpath "sum(//testsuite/@tests)" target/surefire-reports/TEST-*.xml 2>/dev/null || echo "0")
          FAILURES=$(xmllint --xpath "sum(//testsuite/@failures)" target/surefire-reports/TEST-*.xml 2>/dev/null || echo "0")
          ERRORS=$(xmllint --xpath "sum(//testsuite/@errors)" target/surefire-reports/TEST-*.xml 2>/dev/null || echo "0")
          SKIPPED=$(xmllint --xpath "sum(//testsuite/@skipped)" target/surefire-reports/TEST-*.xml 2>/dev/null || echo "0")
          PASSED=$((TOTAL_TESTS - FAILURES - ERRORS - SKIPPED))
          
          if [ $TOTAL_TESTS -gt 0 ]; then
            SUCCESS_RATE=$(echo "scale=1; $PASSED * 100 / $TOTAL_TESTS" | bc -l)
          else
            SUCCESS_RATE="0.0"
          fi
          
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILURES" >> $GITHUB_OUTPUT
          echo "error_tests=$ERRORS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=${SUCCESS_RATE}%" >> $GITHUB_OUTPUT
        else
          echo "total_tests=0" >> $GITHUB_OUTPUT
          echo "passed_tests=0" >> $GITHUB_OUTPUT
          echo "failed_tests=0" >> $GITHUB_OUTPUT
          echo "error_tests=0" >> $GITHUB_OUTPUT
          echo "skipped_tests=0" >> $GITHUB_OUTPUT
          echo "success_rate=0%" >> $GITHUB_OUTPUT
        fi
        
        # Parse JaCoCo coverage results
        if [ -f "target/site/jacoco/jacoco.xml" ]; then
          INSTRUCTION_COVERED=$(grep -o '<counter type="INSTRUCTION" missed="[0-9]*" covered="[0-9]*"/>' target/site/jacoco/jacoco.xml | tail -1 | sed 's/.*covered="\([0-9]*\)".*/\1/' || echo "0")
          INSTRUCTION_MISSED=$(grep -o '<counter type="INSTRUCTION" missed="[0-9]*" covered="[0-9]*"/>' target/site/jacoco/jacoco.xml | tail -1 | sed 's/.*missed="\([0-9]*\)".*/\1/' || echo "0")
          BRANCH_COVERED=$(grep -o '<counter type="BRANCH" missed="[0-9]*" covered="[0-9]*"/>' target/site/jacoco/jacoco.xml | tail -1 | sed 's/.*covered="\([0-9]*\)".*/\1/' || echo "0")
          BRANCH_MISSED=$(grep -o '<counter type="BRANCH" missed="[0-9]*" covered="[0-9]*"/>' target/site/jacoco/jacoco.xml | tail -1 | sed 's/.*missed="\([0-9]*\)".*/\1/' || echo "0")
          LINE_COVERED=$(grep -o '<counter type="LINE" missed="[0-9]*" covered="[0-9]*"/>' target/site/jacoco/jacoco.xml | tail -1 | sed 's/.*covered="\([0-9]*\)".*/\1/' || echo "0")
          LINE_MISSED=$(grep -o '<counter type="LINE" missed="[0-9]*" covered="[0-9]*"/>' target/site/jacoco/jacoco.xml | tail -1 | sed 's/.*missed="\([0-9]*\)".*/\1/' || echo "0")
          
          INSTRUCTION_TOTAL=$((INSTRUCTION_COVERED + INSTRUCTION_MISSED))
          BRANCH_TOTAL=$((BRANCH_COVERED + BRANCH_MISSED))
          LINE_TOTAL=$((LINE_COVERED + LINE_MISSED))
          
          if [ $INSTRUCTION_TOTAL -gt 0 ]; then
            INSTRUCTION_PCT=$(echo "scale=1; $INSTRUCTION_COVERED * 100 / $INSTRUCTION_TOTAL" | bc -l)
          else
            INSTRUCTION_PCT="0.0"
          fi
          
          if [ $BRANCH_TOTAL -gt 0 ]; then
            BRANCH_PCT=$(echo "scale=1; $BRANCH_COVERED * 100 / $BRANCH_TOTAL" | bc -l)
          else
            BRANCH_PCT="0.0"
          fi
          
          if [ $LINE_TOTAL -gt 0 ]; then
            LINE_PCT=$(echo "scale=1; $LINE_COVERED * 100 / $LINE_TOTAL" | bc -l)
          else
            LINE_PCT="0.0"
          fi
          
          echo "instruction_coverage=${INSTRUCTION_PCT}%" >> $GITHUB_OUTPUT
          echo "branch_coverage=${BRANCH_PCT}%" >> $GITHUB_OUTPUT
          echo "line_coverage=${LINE_PCT}%" >> $GITHUB_OUTPUT
          echo "instruction_covered=$INSTRUCTION_COVERED" >> $GITHUB_OUTPUT
          echo "instruction_total=$INSTRUCTION_TOTAL" >> $GITHUB_OUTPUT
          echo "branch_covered=$BRANCH_COVERED" >> $GITHUB_OUTPUT
          echo "branch_total=$BRANCH_TOTAL" >> $GITHUB_OUTPUT
          echo "line_covered=$LINE_COVERED" >> $GITHUB_OUTPUT
          echo "line_total=$LINE_TOTAL" >> $GITHUB_OUTPUT
        else
          echo "instruction_coverage=0%" >> $GITHUB_OUTPUT
          echo "branch_coverage=0%" >> $GITHUB_OUTPUT
          echo "line_coverage=0%" >> $GITHUB_OUTPUT
          echo "instruction_covered=0" >> $GITHUB_OUTPUT
          echo "instruction_total=0" >> $GITHUB_OUTPUT
          echo "branch_covered=0" >> $GITHUB_OUTPUT
          echo "branch_total=0" >> $GITHUB_OUTPUT
          echo "line_covered=0" >> $GITHUB_OUTPUT
          echo "line_total=0" >> $GITHUB_OUTPUT
        fi
        
    - name: Update build metadata with test results
      run: |
        cat > build-metadata.json << EOF
        {
          "build_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "git_commit": "${{ github.sha }}",
          "git_ref": "${{ github.ref }}",
          "workflow_run_id": "${{ github.run_id }}",
          "workflow_run_number": "${{ github.run_number }}",
          "runner_os": "${{ runner.os }}",
          "java_version": "17",
          "maven_version": "$(mvn --version | head -1 | cut -d' ' -f3)",
          "test_results": {
            "total_tests": "${{ steps.test-results.outputs.total_tests }}",
            "passed_tests": "${{ steps.test-results.outputs.passed_tests }}",
            "failed_tests": "${{ steps.test-results.outputs.failed_tests }}",
            "success_rate": "${{ steps.test-results.outputs.success_rate }}"
          },
          "code_coverage": {
            "instruction_coverage": "${{ steps.test-results.outputs.instruction_coverage }}",
            "branch_coverage": "${{ steps.test-results.outputs.branch_coverage }}",
            "line_coverage": "${{ steps.test-results.outputs.line_coverage }}"
          },
          "build_environment": {
            "github_actor": "${{ github.actor }}",
            "github_repository": "${{ github.repository }}",
            "github_event_name": "${{ github.event_name }}"
          }
        }
        EOF
        
    - name: Generate artifact hashes
      id: hash
      run: |
        cd target
        echo "Generating SHA256 hashes for all artifacts..."
        
        # Create comprehensive hash file
        sha256sum *.jar *.pom *.asc > ../artifacts.sha256
        
        # Generate individual hash files for each artifact
        for file in *.jar *.pom; do
          if [ -f "$file" ]; then
            sha256sum "$file" > "../${file}.sha256"
            echo "Generated hash for $file"
          fi
        done
        
        # Create base64 encoded hashes for GitHub attestations
        hashes=$(sha256sum *.jar *.pom | base64 -w 0)
        echo "hashes=$hashes" >> $GITHUB_OUTPUT
        
        # List all generated files
        echo "Generated artifacts:"
        ls -la *.jar *.pom *.asc
        
    - name: Generate SBOM hash
      id: sbom-hash
      run: |
        sbom_hash=$(sha256sum sbom.spdx.json | cut -d' ' -f1)
        echo "hash=$sbom_hash" >> $GITHUB_OUTPUT
        echo "SBOM SHA256: $sbom_hash"
        
    - name: Generate release summary
      run: |
        echo "## 🚀 Release Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Build Information
        echo "### 🏗️ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build Timestamp | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
        echo "| Git Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow Run | [${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| Java Version | 17 |" >> $GITHUB_STEP_SUMMARY
        echo "| Maven Version | $(mvn --version | head -1 | cut -d' ' -f3) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Test Results
        echo "### 🧪 Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Total Tests | ${{ steps.test-results.outputs.total_tests }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Passed | ${{ steps.test-results.outputs.passed_tests }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Failed | ${{ steps.test-results.outputs.failed_tests }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Errors | ${{ steps.test-results.outputs.error_tests }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Skipped | ${{ steps.test-results.outputs.skipped_tests }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Success Rate | ${{ steps.test-results.outputs.success_rate }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Code Coverage
        echo "### 📈 Code Coverage" >> $GITHUB_STEP_SUMMARY
        echo "| Coverage Type | Covered | Total | Percentage |" >> $GITHUB_STEP_SUMMARY
        echo "|---------------|---------|-------|------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Instructions | ${{ steps.test-results.outputs.instruction_covered }} | ${{ steps.test-results.outputs.instruction_total }} | ${{ steps.test-results.outputs.instruction_coverage }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branches | ${{ steps.test-results.outputs.branch_covered }} | ${{ steps.test-results.outputs.branch_total }} | ${{ steps.test-results.outputs.branch_coverage }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lines | ${{ steps.test-results.outputs.line_covered }} | ${{ steps.test-results.outputs.line_total }} | ${{ steps.test-results.outputs.line_coverage }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Security Attestations
        echo "### 🔒 Security Attestations" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ SLSA Level 3 Provenance generated" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ SPDX SBOM: \`sbom.spdx.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ CycloneDX SBOM: \`sbom.cyclonedx.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ GPG signatures generated" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ SHA-256 checksums created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Artifacts
        echo "### 📦 Release Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "**Main Artifacts:**" >> $GITHUB_STEP_SUMMARY
        ls target/*.jar target/*.pom | while read file; do
          basename_file=$(basename "$file")
          size=$(stat -c%s "$file" | numfmt --to=iec)
          echo "- $basename_file ($size)" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Attestation Artifacts:**" >> $GITHUB_STEP_SUMMARY
        echo "- sbom.spdx.json - SPDX Software Bill of Materials" >> $GITHUB_STEP_SUMMARY
        echo "- sbom.cyclonedx.json - CycloneDX Software Bill of Materials" >> $GITHUB_STEP_SUMMARY
        echo "- vulnerability-report.json - Security vulnerability report" >> $GITHUB_STEP_SUMMARY
        echo "- build-metadata.json - Build environment metadata" >> $GITHUB_STEP_SUMMARY
        echo "- *.sha256 - SHA-256 checksums" >> $GITHUB_STEP_SUMMARY
        echo "- *.asc - GPG signatures" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
    - name: Create verification instructions
      run: |
        echo "# Artifact Verification Instructions" > VERIFICATION.md
        echo "" >> VERIFICATION.md
        echo "## GPG Signature Verification" >> VERIFICATION.md
        echo "gpg --verify ghrelasset-wagon-*.jar.asc ghrelasset-wagon-*.jar" >> VERIFICATION.md
        echo "" >> VERIFICATION.md
        echo "## SHA256 Hash Verification" >> VERIFICATION.md
        echo "sha256sum -c artifacts.sha256" >> VERIFICATION.md
        echo "" >> VERIFICATION.md
        echo "## SLSA Provenance Verification" >> VERIFICATION.md
        echo "slsa-verifier verify-artifact ghrelasset-wagon-*.jar --provenance-path *.intoto.jsonl --source-uri github.com/$GITHUB_REPOSITORY" >> VERIFICATION.md
        echo "" >> VERIFICATION.md
        echo "## SBOM Vulnerability Scanning" >> VERIFICATION.md
        echo "grype sbom:sbom.spdx.json" >> VERIFICATION.md
        
    - name: Generate GitHub Attestations
      uses: actions/attest-build-provenance@v1
      with:
        subject-path: |
          target/*.jar
          target/*.pom
          sbom.spdx.json
          sbom.cyclonedx.json
          
    - name: Generate SBOM Attestation
      uses: actions/attest-sbom@v1
      with:
        subject-path: target/*.jar
        sbom-path: sbom.spdx.json
        
    - name: Upload attestation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: attestation-artifacts
        path: |
          target/*.jar
          target/*.pom
          target/*.jar.asc
          target/*.pom.asc
          *.sha256
          sbom.spdx.json
          sbom.cyclonedx.json
          vulnerability-report.json
          build-metadata.json
          VERIFICATION.md
        retention-days: 90
        
  slsa-provenance:
    needs: build-and-attest
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.build-and-attest.outputs.artifact-hashes }}"
      
  deploy-to-maven-central:
    needs: [build-and-attest, slsa-provenance]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        server-id: central
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        settings-path: ${{ github.workspace }}
        
    - name: Download attestation artifacts
      uses: actions/download-artifact@v4
      with:
        name: attestation-artifacts
        path: ./
        
    - name: Deploy to Maven Central using pre-built artifacts
      env:
        MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        echo "🚀 Deploying pre-built artifacts to Maven Central..."
        
        # Use Maven deploy plugin with pre-built artifacts
        # Skip compilation/packaging phases since artifacts are already built
        mvn deploy -DskipTests -Dmaven.main.skip=true -Dmaven.test.skip=true \
          -Dgpg.passphrase="${GPG_PASSPHRASE}" \
          -s ${{ github.workspace }}/settings.xml
          
        echo "✅ Deployment completed successfully"
        
  attach-to-release:
    needs: [build-and-attest, slsa-provenance, deploy-to-maven-central]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'release' }}
    
    steps:
    - name: Download attestation artifacts
      uses: actions/download-artifact@v4
      with:
        name: attestation-artifacts
        path: ./attestations/
        
    - name: Download SLSA provenance
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.slsa-provenance.outputs.provenance-name }}
        path: ./slsa/
        
    - name: Attach attestations to release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          attestations/*.jar
          attestations/*.pom
          attestations/*.asc
          attestations/*.sha256
          attestations/sbom.spdx.json
          attestations/sbom.cyclonedx.json
          attestations/trivy-results.sarif
          attestations/vulnerability-report.json
          attestations/build-metadata.json
          slsa/*.intoto.jsonl
        body: |
          ## 🚀 Release Build Summary
          
          **Build Information:**
          - **Build Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - **Git Commit:** ${{ github.sha }}
          - **Workflow Run:** [${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Java Version:** 17
          - **Maven Version:** $(mvn --version | head -1 | cut -d' ' -f3)
          
          ## 🧪 Test Results
          
          | Metric | Value |
          |--------|-------|
          | Total Tests | ${{ needs.build-and-attest.outputs.total_tests || 'N/A' }} |
          | Passed | ${{ needs.build-and-attest.outputs.passed_tests || 'N/A' }} |
          | Failed | ${{ needs.build-and-attest.outputs.failed_tests || 'N/A' }} |
          | Success Rate | ${{ needs.build-and-attest.outputs.success_rate || 'N/A' }} |
          
          ## 📈 Code Coverage
          
          | Coverage Type | Percentage |
          |---------------|------------|
          | Instructions | ${{ needs.build-and-attest.outputs.instruction_coverage || 'N/A' }} |
          | Branches | ${{ needs.build-and-attest.outputs.branch_coverage || 'N/A' }} |
          | Lines | ${{ needs.build-and-attest.outputs.line_coverage || 'N/A' }} |
          
          ## 🔒 Security Attestations
          
          This release includes comprehensive security attestations and provenance information:
          
          ### 📋 Software Bill of Materials (SBOM)
          - **SPDX Format**: sbom.spdx.json
          - **CycloneDX Format**: sbom.cyclonedx.json
          
          ### 🛡️ Security Scanning
          - **Vulnerability Report**: vulnerability-report.json
          - **SARIF Report**: trivy-results.sarif
          
          ### 🔐 Provenance & Attestations
          - **SLSA Provenance**: *.intoto.jsonl (SLSA Level 3)
          - **Build Metadata**: build-metadata.json
          - **Artifact Hashes**: *.sha256
          
          ### ✍️ Code Signing
          - All artifacts are signed with GPG
          - Signature files: *.asc
          
          ## 📦 Release Artifacts
          
          **Main Artifacts:**
          - JAR: ghrelasset-wagon-*.jar
          - Sources: ghrelasset-wagon-*-sources.jar
          - Javadoc: ghrelasset-wagon-*-javadoc.jar
          - POM: ghrelasset-wagon-*.pom
          
          **Attestation Artifacts:**
          - sbom.spdx.json - SPDX Software Bill of Materials
          - sbom.cyclonedx.json - CycloneDX Software Bill of Materials
          - vulnerability-report.json - Security vulnerability report
          - build-metadata.json - Build environment metadata
          - *.sha256 - SHA-256 checksums
          - *.asc - GPG signatures
          
          ## 🔍 Verification
          
          See the attached VERIFICATION.md file for detailed instructions on verifying GPG signatures, SHA256 hashes, SLSA provenance, and scanning SBOMs for vulnerabilities.
          
          ## 🏗️ Build Environment
          
          - **Runner OS:** ubuntu-latest
          - **Build Actor:** ${{ github.actor }}
          - **Repository:** ${{ github.repository }}
          - **Event:** ${{ github.event_name }}
          
          All attestations are also available in Maven Central alongside the published artifacts.
          
          For detailed information about security attestations, see [Security Attestations Documentation](docs/SECURITY_ATTESTATIONS.md).
